AWSTemplateFormatVersion: "2010-09-09"
Description: Infra Main Stack

Parameters:

  ProjectName:
    Type: String
    Description: The name of the project

  TemplateBucket:
    Type: String
    Description: S3 bucket name for the Nested Stacks

  MaxContainers:
    Type: Number
    Description: Max containers to scale to
    Default: 2

  SecretsArn:
    Type: String
    Description: secrets-manager resource name

  GitHubOwner:
    Type: String
    Description: GitHub Owner

  ServerRepository:
    Type: String
    Description: Server Repository name

  ServerBranch:
    Type: String
    Description: GitHub Branch to subscribe

  WebRepository:
    Type: String

  WebBranch:
    Type: String

  CodeStarConnectionArn:
    Type: String
    Description: CodeStar Resource Arn for subscribe codes

  DomainName:
    Type: String

  HostedZoneId:
    Type: String

  EnvironmentStage:
    Type: String
    AllowedValues:
      - prod

  EC2KeyName:
    Type: String

Resources:
  ECSCluterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/backend/cluster/cluster.yaml
      TimeoutInMinutes: 20

  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/network.yaml
      TimeoutInMinutes: 20
      Parameters:
        ProjectName: !Ref ProjectName
      Tags:
        - Key: Name
          Value: !Ref ProjectName

  ALBStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/alb.yaml
      Parameters:
        ProjectName: !Ref ProjectName
        NetworkStack: !Select [ 1, !Split [ "/", !Ref NetworkStack ] ]
        ServerDomainName:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - egg-signal-server
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName
        WebDomainName:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - egg-signal-app
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName
        OpenviduDomainName:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - openvidu
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName
        ServerCertificateStack: !Select [ 1, !Split [ "/", !Ref APICertificate ] ]
        WebCertificateStack: !Select [ 1, !Split [ "/", !Ref WebCertificate ] ]
        HostedZoneId: !Ref HostedZoneId

  ECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/backend/ecs.yaml
      Parameters:
        NetworkStack: !Select [ 1, !Split [ "/", !Ref NetworkStack ] ]
        ALBStack: !Select [ 1, !Split [ "/", !Ref ALBStack ] ]
        MaxContainers: !Ref MaxContainers
        SecretsArn: !Ref SecretsArn
        ECSCluterStack: !Select [ 1, !Split [ "/", !Ref ECSCluterStack ] ]

  ServerPipelineStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/backend/pipeline.yaml
      TimeoutInMinutes: 20
      Parameters:
        ECSStack: !Select [ 1, !Split [ '/', !Ref ECSStack ] ]
        Owner: !Ref GitHubOwner
        Repo: !Ref ServerRepository
        Branch: !Ref ServerBranch
        CodeStarConnectionArn: !Ref CodeStarConnectionArn
        ECSCluterStack: !Select [ 1, !Split [ "/", !Ref ECSCluterStack ] ]

  Notification:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/notifications/pipelineNotification.yaml
      Parameters:
        ServerPipelineStack: !Select [ 1, !Split [ '/', !Ref ServerPipelineStack ] ]
        WebPipelineStack: !Select [ 1, !Split [ '/', !Ref WebPipelineStack ] ]
        LambdaStack: !Select [ 1, !Split [ '/', !Ref LambdaStack ] ]
        ServerNotificationName:
          Fn::Join:
            - ''
            - - egg-signal-server
              - Fn::FindInMap:
                  - SubdomainSuffixMap
                  - !Ref EnvironmentStage
                  - value
        WebNotificationName:
          Fn::Join:
            - ''
            - - egg-signal-app
              - Fn::FindInMap:
                  - SubdomainSuffixMap
                  - !Ref EnvironmentStage
                  - value

  APICertificate:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/backend/certificate.yaml
      TimeoutInMinutes: 20
      Parameters:
        DomainName:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - egg-signal-server
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName
        OpenviduDomainName:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - openvidu
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName
        HostedZoneId: !Ref HostedZoneId

  LambdaStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://${TemplateBucket}.s3.${AWS::URLSuffix}/lambda.yaml
      Parameters:
        ProjectName: !Ref ProjectName
        EnvironmentStage: !Ref EnvironmentStage
        SecretsArn: !Ref SecretsArn

  WebECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/frontend/ecs.yaml
      Parameters:
        NetworkStack: !Select [ 1, !Split [ "/", !Ref NetworkStack ] ]
        ALBStack: !Select [ 1, !Split [ "/", !Ref ALBStack ] ]
        MaxContainers: !Ref MaxContainers
        SecretsArn: !Ref SecretsArn
        ECSCluterStack: !Select [ 1, !Split [ "/", !Ref ECSCluterStack ] ]

  WebPipelineStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/frontend/pipeline.yaml
      TimeoutInMinutes: 20
      Parameters:
        WebECSStack: !Select [ 1, !Split [ '/', !Ref WebECSStack ] ]
        Owner: !Ref GitHubOwner
        Repo: !Ref WebRepository
        Branch: !Ref WebBranch
        CodeStarConnectionArn: !Ref CodeStarConnectionArn
        ServerDomain:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - egg-signal-server
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName
        SecretsArn: !Ref SecretsArn
        ECSCluterStack: !Select [ 1, !Split [ "/", !Ref ECSCluterStack ] ]

  WebCertificate:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/frontend/certificate.yaml
      TimeoutInMinutes: 20
      Parameters:
        DomainName:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - egg-signal-app
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName
        HostedZoneId: !Ref HostedZoneId

  OpenviduStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/backend/openvidu.yaml
      TimeoutInMinutes: 20
      Parameters:
        KeyName: !Ref EC2KeyName
        NetworkStack: !Select [ 1, !Split [ "/", !Ref NetworkStack ] ]
        HostedZoneId: !Ref HostedZoneId
        OpenviduDomainName:
          Fn::Join:
            - '.'
            - - Fn::Join:
                  - ''
                  - - openvidu
                    - Fn::FindInMap:
                        - SubdomainSuffixMap
                        - !Ref EnvironmentStage
                        - value
              - !Ref DomainName

  NamespaceStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/namespace.yaml
      TimeoutInMinutes: 20
      Parameters:
        NetworkStack: !Select [ 1, !Split [ "/", !Ref NetworkStack ] ]
        ProjectName: !Ref ProjectName

  RedisStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateBucket}.s3.amazonaws.com/backend/redis.yaml
      TimeoutInMinutes: 20
      Parameters:
        NetworkStack: !Select [ 1, !Split [ "/", !Ref NetworkStack ] ]
        ALBStack: !Select [ 1, !Split [ "/", !Ref ALBStack ] ]
        ECSClusterStack: !Select [ 1, !Split [ "/", !Ref ECSCluterStack ] ]
        ProjectName: !Ref ProjectName
        NamespaceStack: !Select [ 1, !Split [ "/", !Ref NamespaceStack ] ]

Mappings:
  SubdomainSuffixMap:
    prod:
      value: ''
